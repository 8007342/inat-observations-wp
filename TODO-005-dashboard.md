# TODO-005: Static Dashboard Build System

**Created:** 2026-01-06
**Status:** ✅ Complete (Core Implementation)
**Priority:** MEDIUM
**Effort:** 4 hours (actual)

---

## Overview

Built a **STATIC** dashboard build system that generates HTML/Markdown metrics reports at build time using standard open-source tools. Dashboard files are build artifacts, not runtime code.

**Key Principle:** Dashboard is STATIC MARKUP generated during pre-commit, not runtime PHP scripts.

---

## Architecture

### What We Built ✅

```
dashboard/
├── README.md              # Documentation (committed to git)
├── .gitkeep               # Ensure directory exists
├── coverage/              # PHPUnit HTML coverage (build artifact, ignored)
│   └── index.html
├── metrics.json           # Machine-readable snapshot (build artifact, ignored)
├── metrics.md             # Human-readable report (build artifact, ignored)
└── history/               # Historical snapshots (build artifacts, ignored)
    └── YYYY-MM-DD-HHMMSS-{commit}-metrics.json
```

### Build Tools ✅

```
bin/
├── generate-metrics.php   # Parses clover.xml → metrics.json + metrics.md
└── install-hooks.php      # Installs pre-commit hook
```

### Composer Scripts ✅

```json
{
  "scripts": {
    "test:coverage": "phpunit --coverage-html dashboard/coverage --coverage-clover dashboard/coverage/clover.xml",
    "metrics:generate": "php bin/generate-metrics.php",
    "dashboard:build": ["@test:coverage", "@metrics:generate"],
    "install-hooks": "php bin/install-hooks.php"
  }
}
```

---

## How It Works

### Build Process

1. **Run Tests with Coverage**
   ```bash
   composer test:coverage
   ```
   - PHPUnit generates `dashboard/coverage/index.html` (HTML report)
   - PHPUnit generates `dashboard/coverage/clover.xml` (machine-readable XML)

2. **Generate Metrics**
   ```bash
   composer metrics:generate
   ```
   - Parses `clover.xml` for coverage percentages
   - Runs `composer lint` to count warnings/errors
   - Writes `dashboard/metrics.json` (machine-readable)
   - Writes `dashboard/metrics.md` (human-readable)

3. **Full Build**
   ```bash
   composer dashboard:build
   ```
   - Runs both steps above
   - All dashboard files are static artifacts

### Pre-Commit Hook

When installed (`composer install-hooks`), automatically runs on every commit:

```bash
.git/hooks/pre-commit:
1. Run composer test:coverage
2. Run composer metrics:generate
3. Snapshot metrics to history/
4. Stage dashboard artifacts
5. Check quality gates (optional, currently disabled)
```

---

## Artifacts Generated

### 1. `dashboard/coverage/index.html`

**Type:** Static HTML (generated by PHPUnit)

**Viewing:**
```bash
open dashboard/coverage/index.html
```

**Contains:**
- File-by-file coverage breakdown
- Line-by-line highlighting (covered/uncovered)
- Function and class coverage
- Interactive HTML report

**Tool:** PHPUnit's `--coverage-html` flag

---

### 2. `dashboard/metrics.json`

**Type:** Static JSON (generated by bin/generate-metrics.php)

**Viewing:**
```bash
jq '.' dashboard/metrics.json
```

**Structure:**
```json
{
  "generated": "2026-01-06T14:30:00Z",
  "git_commit": "abc123",
  "coverage": {
    "line_percentage": 97.5,
    "function_percentage": 98.2,
    "class_percentage": 100.0,
    "files": [...]
  },
  "quality": {
    "warnings": 0,
    "errors": 0
  }
}
```

**Use Case:** CI/CD pipelines, automated quality gates

---

### 3. `dashboard/metrics.md`

**Type:** Static Markdown (generated by bin/generate-metrics.php)

**Viewing:**
```bash
cat dashboard/metrics.md
# Or on GitHub: browse to dashboard/metrics.md
```

**Contains:**
- Overall project health score
- Coverage tables
- Per-file breakdown
- Quality gate status
- Human-readable summary

**Use Case:** Quick health check, GitHub README linking

---

### 4. `dashboard/history/*.json`

**Type:** Historical snapshots (timestamped)

**Naming:**
```
YYYY-MM-DD-HHMMSS-{commit}-metrics.json
```

**Use Case:** Track metrics trends over time

---

## Quality Gates

Enforced in CI/CD using `metrics.json`:

```yaml
# .github/workflows/quality-gates.yml
- name: Check Coverage Threshold
  run: |
    COVERAGE=$(jq -r '.coverage.line_percentage' dashboard/metrics.json)
    if (( $(echo "$COVERAGE < 97" | bc -l) )); then
      echo "❌ Coverage below 97%: $COVERAGE%"
      exit 1
    fi

- name: Check Code Quality
  run: |
    WARNINGS=$(jq -r '.quality.warnings' dashboard/metrics.json)
    if [ "$WARNINGS" -gt 0 ]; then
      echo "❌ Found $WARNINGS warnings"
      exit 1
    fi
```

---

## Tools Used (All Standard, Open-Source)

- **PHPUnit** - Code coverage HTML/XML generation
- **PHP_CodeSniffer** - Code quality analysis (warnings/errors)
- **jq** - JSON parsing in CI/CD scripts
- **Git hooks** - Automated pre-commit builds

**NO CUSTOM RUNTIME CODE** - All standard tools with static output.

---

## Git Configuration

### .gitignore

```gitignore
# Dashboard artifacts (static build outputs)
/dashboard/coverage/
/dashboard/metrics.json
/dashboard/metrics.md
/dashboard/history/

# Keep README.md in git
!/dashboard/README.md
```

**Rationale:** Dashboard files are build artifacts, regenerated on every commit. Only README.md (documentation) is committed.

---

## Usage Examples

### Developer Workflow

```bash
# Make code changes
vim wp-content/plugins/inat-observations-wp/includes/api.php

# Run tests
composer test

# Build dashboard
composer dashboard:build

# View coverage
open dashboard/coverage/index.html

# Quick health check
cat dashboard/metrics.md

# Commit (pre-commit hook runs automatically)
git add .
git commit -m "Add API error handling"
```

### CI/CD Pipeline

```yaml
- name: Install Dependencies
  run: composer install

- name: Build Dashboard
  run: composer dashboard:build

- name: Enforce Quality Gates
  run: |
    php -r "
      \$m = json_decode(file_get_contents('dashboard/metrics.json'));
      if (\$m->coverage->line_percentage < 97) exit(1);
      if (\$m->quality->warnings > 0) exit(1);
      if (\$m->quality->errors > 0) exit(1);
    "

- name: Upload Coverage Report
  uses: actions/upload-artifact@v3
  with:
    name: coverage-report
    path: dashboard/coverage/
```

---

## Next Steps

### Immediate
- ✅ Dashboard structure created
- ✅ Build scripts implemented
- ✅ Composer targets defined
- ✅ .gitignore configured
- ⏸ Install pre-commit hook: `composer install-hooks`
- ⏸ Run initial build: `composer dashboard:build`

### Future Enhancements
- ⏸ Add dead code detection (PHPMD integration)
- ⏸ Add complexity metrics (cyclomatic complexity)
- ⏸ Trend charts (coverage over time)
- ⏸ GitHub Pages deployment for coverage reports

---

## Integration with TODO-QA-001

See `TODO-QA-001-track-code-coverage-metrics.md` for:
- Coverage improvement roadmap (target 97%+)
- File-by-file testing strategy
- Quality targets (0 warnings, 0 errors)

Dashboard provides the **measurement system** to track progress toward QA goals.

---

## Success Criteria ✅

- ✅ Dashboard is 100% static markup (no runtime code)
- ✅ Uses standard open-source tools (PHPUnit, PHPCS)
- ✅ Build artifacts ignored in git (except README.md)
- ✅ Pre-commit hook automation available
- ✅ CI/CD integration ready (metrics.json)
- ✅ Comprehensive documentation (README.md)

---

**Completed:** 2026-01-06
**Reviewed by:** Developer
**Status:** Core implementation complete, ready for use
